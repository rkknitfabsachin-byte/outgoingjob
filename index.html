<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RK KNIT FAB â€“ Outgoing Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0c0f16;
    --card:#151924;
    --text:#eef2f8;
    --muted:#9ca3af;
    --accent:#5bc7ff;
    --ring:#2a2f38;
    --shadow:0 8px 24px rgba(0,0,0,0.35);
  }

  /* LIGHT THEME */
  .light{
    --bg:#f7f8fc;
    --card:#ffffff;
    --text:#111520;
    --muted:#6d7380;
    --accent:#007bff;
    --ring:#e3e6eb;
    --shadow:0 4px 14px rgba(0,0,0,0.08);
  }

  body{
    margin:0;
    font-family:Inter;
    background:var(--bg);
    color:var(--text);
    transition:0.3s ease;
  }

  /* Navbar */
  .navbar{
    position:fixed;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    width:90%;
    max-width:900px;
    background:var(--card);
    border:1px solid var(--ring);
    border-radius:18px;
    padding:14px 18px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    backdrop-filter:blur(14px);
    box-shadow:var(--shadow);
    z-index:50;
  }

  .nav-title{
    font-size:20px;
    font-weight:700;
  }

  /* Theme Switch */
  .theme-toggle{
    padding:10px 14px;
    border-radius:14px;
    border:1px solid var(--ring);
    background:var(--card);
    cursor:pointer;
    font-size:14px;
    transition:0.3s ease;
  }

  .container{
    margin-top:120px;
    padding:20px;
    max-width:1050px;
    margin:auto;
  }

  /* Filter Section */
  .filter-card{
    background:var(--card);
    border:1px solid var(--ring);
    padding:20px;
    border-radius:18px;
    margin-bottom:20px;
    box-shadow:var(--shadow);
  }

  label{color:var(--muted);font-size:14px;}

  select,input{
    width:100%;
    padding:12px;
    border-radius:12px;
    background:#1b1f2b;
    border:1px solid var(--ring);
    color:var(--text);
    margin-top:5px;
    transition:0.25s ease;
  }
  .light select,.light input{
    background:#f1f1f5;
    border:1px solid #d0d2d8;
    color:#111520;
  }

  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:16px;
    margin-top:15px;
  }

  .apply{
    background:var(--accent);
    padding:14px;
    border-radius:12px;
    border:none;
    font-weight:600;
    color:#000;
    cursor:pointer;
    width:140px;
  }
  .reset{
    width:140px;
    background:var(--card);
    border:1px solid var(--ring);
    padding:14px;
    border-radius:12px;
    color:var(--muted);
    cursor:pointer;
  }

  /* Summary Box */
  .summary{
    background:var(--card);
    border:1px solid var(--ring);
    padding:16px;
    border-radius:18px;
    margin-bottom:20px;
  }

  /* Table */
  .table-wrap{
    background:var(--card);
    padding:12px;
    border-radius:18px;
    border:1px solid var(--ring);
    box-shadow:var(--shadow);
    overflow-x:auto;
  }

  table{width:100%;border-collapse:collapse;}
  th{
    padding:10px;
    color:var(--muted);
    font-size:13px;
    border-bottom:1px solid var(--ring);
  }
  td{
    padding:12px 10px;
    border-bottom:1px solid #1e242e;
  }
  .qty{text-align:right;font-weight:700;}

  /* Loader Shimmer */
  .loader{
    height:14px;
    width:100%;
    background:linear-gradient(90deg,#2a2f38 0%,#3a3f48 50%,#2a2f38 100%);
    background-size:200% 100%;
    animation:shimmer 1.3s infinite linear;
    border-radius:6px;
  }
  @keyframes shimmer{
    from{background-position:-200% 0;}
    to{background-position:200% 0;}
  }

  .loader-row{
    background:var(--card);
    border:1px solid var(--ring);
    border-radius:14px;
    padding:12px;
    margin:12px 0;
  }

  /* Mobile Card View */
  @media(max-width:650px){
    th{display:none;}
    table,tbody,tr,td{display:block;width:100%;}
    tr{background:#131722;border:1px solid var(--ring);padding:14px;margin:12px 0;border-radius:14px;}
    .light tr{background:#ffffff;}
    td{border:none;display:flex;justify-content:space-between;padding:7px;}
    td::before{content:attr(data-label);font-size:12px;color:var(--muted);}
  }

  /* PDF Button */
  .pdf-btn{
    margin-top:30px;
    width:100%;
    background:var(--accent);
    color:#000;
    padding:16px;
    border-radius:14px;
    border:none;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
  }
</style>
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">
  <div class="nav-title">RK KNIT FAB â€“ Outgoing</div>
  <button class="theme-toggle" id="themeBtn">ðŸŒ™ Dark</button>
</div>

<div class="container">

  <!-- Filters -->
  <div class="filter-card">
    <h3>Filters</h3>

    <div class="grid">
      <div><label>Party</label><select id="party"></select></div>
      <div><label>Yarn</label><select id="yarn"></select></div>
      <div><label>Mill</label><select id="mill"></select></div>
      <div><label>Challan</label><input id="challan" placeholder="Number"></div>
      <div><label>Date From</label><input id="from" type="date"></div>
      <div><label>Date To</label><input id="to" type="date"></div>
    </div>

    <div style="display:flex; gap:16px; margin-top:18px;">
      <button class="apply" id="apply">Apply</button>
      <button class="reset" id="reset">Reset</button>
    </div>
  </div>

  <!-- Summary -->
  <div class="summary">
    <strong>Total Qty:</strong> <span id="total">0</span> kg<br>
    <strong>Rows:</strong> <span id="rows">0</span><br>
    <span id="rangeTxt" style="font-size:12px;color:var(--muted);"></span>
  </div>

  <!-- Table -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Challan</th><th>Party</th><th>Yarn</th><th>Qty</th><th>Mill</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <button class="pdf-btn" id="pdfExport">Export to PDF</button>

</div>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycby30Tw10MQlbxrDhguutgGTJPtHzq_-_eveQD0rKwc-Dr2jEktG039_UsQBh1yGy-Co1Q/exec";

const $ = x => document.querySelector(x);
const els = {
  party: $('#party'),
  yarn: $('#yarn'),
  mill: $('#mill'),
  challan: $('#challan'),
  from: $('#from'),
  to: $('#to'),
  tbody: $('#tbody'),
  total: $('#total'),
  rows: $('#rows'),
  rangeTxt: $('#rangeTxt')
};

/* Format date -> dd-mm-yyyy */
function fmt(d){
  const x=new Date(d);
  return `${String(x.getDate()).padStart(2,'0')}-${String(x.getMonth()+1).padStart(2,'0')}-${x.getFullYear()}`;
}

function showLoader(){
  els.tbody.innerHTML = `
    <tr class="loader-row"><td colspan="6"><div class="loader"></div></td></tr>
    <tr class="loader-row"><td colspan="6"><div class="loader"></div></td></tr>
    <tr class="loader-row"><td colspan="6"><div class="loader"></div></td></tr>
  `;
}

async function fetchData(p={}) {
  showLoader();

  const url=new URL(API_BASE);
  url.searchParams.set("route","getData");
  Object.keys(p).forEach(k=>url.searchParams.set(k,p[k]));

  const r=await fetch(url);
  const j=await r.json();

  if(!j.ok){ els.tbody.innerHTML = `<tr><td colspan="6">${j.error}</td></tr>`; return; }

  populate(j.meta);
  render(j.data);
  summary(j.data,j.meta);
}

function populate(meta){
  const fill=(el,arr)=>{ el.innerHTML=`<option value="">All</option>`+arr.map(v=>`<option>${v}</option>`).join(''); }
  fill(els.party,meta.parties);
  fill(els.yarn,meta.yarns);
  fill(els.mill,meta.mills);
}

function render(rows){
  if(!rows.length){ els.tbody.innerHTML = `<tr><td colspan="6">No data</td></tr>`; return; }

  els.tbody.innerHTML = rows.map(r=>`
    <tr>
      <td data-label="Date">${fmt(r.date)}</td>
      <td data-label="Challan">${r.challan}</td>
      <td data-label="Party">${r.party}</td>
      <td data-label="Yarn">${r.yarn}</td>
      <td data-label="Qty" class="qty">${Number(r.qty).toLocaleString()}</td>
      <td data-label="Mill">${r.mill}</td>
    </tr>
  `).join('');
}

function summary(rows,meta){
  els.total.textContent = rows.reduce((a,b)=>a+Number(b.qty),0).toLocaleString();
  els.rows.textContent = rows.length;
  els.rangeTxt.textContent = `${fmt(meta.range.from)} â†’ ${fmt(meta.range.to)}`;
}

function apply(){
  const p={};
  if(els.party.value) p.party = els.party.value;
  if(els.yarn.value) p.yarn = els.yarn.value;
  if(els.mill.value) p.mill = els.mill.value;
  if(els.challan.value) p.challan = els.challan.value;
  if(els.from.value) p.dateFrom = els.from.value;
  if(els.to.value) p.dateTo = els.to.value;
  fetchData(p);
}

$("#apply").onclick = apply;
$("#reset").onclick = ()=>{
  els.party.value=""; els.yarn.value=""; els.mill.value="";
  els.challan.value=""; els.from.value=""; els.to.value="";
  fetchData({lastDays:3});
};

/* PDF Export */
$("#pdfExport").onclick = ()=>{
  const p=new URLSearchParams();
  if(els.party.value) p.set("party",els.party.value);
  if(els.yarn.value) p.set("yarn",els.yarn.value);
  if(els.mill.value) p.set("mill",els.mill.value);
  if(els.challan.value) p.set("challan",els.challan.value);
  if(els.from.value) p.set("dateFrom",els.from.value);
  if(els.to.value) p.set("dateTo",els.to.value);

  window.open(API_BASE+"?route=exportPDF&"+p.toString(),"_blank");
};

/* THEME TOGGLE */
$("#themeBtn").onclick = ()=>{
  document.body.classList.toggle("light");
  $("#themeBtn").textContent = document.body.classList.contains("light") ? "ðŸŒž Light" : "ðŸŒ™ Dark";
};

/* Initial load */
fetchData({lastDays:3});
</script>

</body>
</html>
