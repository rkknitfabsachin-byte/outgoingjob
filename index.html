<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RK KNIT FAB ‚Äì Outgoing View</title>
<meta name="color-scheme" content="dark light">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #0b0f14;
    --card: rgba(255,255,255,0.06);
    --text: #e8eef6;
    --muted: #98a2b3;
    --ring: rgba(255,255,255,0.25);
    --glass: rgba(255,255,255,0.08);
    --shadow: 0 10px 30px rgba(0,0,0,0.35);
    --accent: #62d0ff;
    --accent-2: #9b8cff;
    --ok: #34d399;
    --warn: #f59e0b;
    --danger: #ef4444;
  }
  .light{
    --bg: #f6f7fb;
    --card: rgba(255,255,255,0.85);
    --text: #0b1220;
    --muted: #556070;
    --ring: rgba(0,0,0,0.08);
    --glass: rgba(255,255,255,0.9);
    --shadow: 0 10px 30px rgba(0,0,0,0.08);
    --accent: #0066ff;
    --accent-2: #8a5cff;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    background: radial-gradient(1200px 800px at 80% -10%, rgba(98,208,255,0.12), transparent 40%),
                radial-gradient(900px 600px at -10% 20%, rgba(155,140,255,0.12), transparent 40%),
                var(--bg);
    color: var(--text);
    transition: background 400ms ease, color 300ms ease;
  }
  .wrap{ max-width:1200px; margin:0 auto; padding:24px; }
  header{
    position: sticky; top:0; z-index:10; backdrop-filter: blur(10px);
    background: linear-gradient(to bottom, rgba(0,0,0,0.35), transparent);
    padding-bottom: 10px;
  }
  .title{
    display:flex; align-items:center; gap:10px; margin:10px 0 16px 0;
  }
  .badge{ font-size:12px; padding:4px 8px; border-radius:999px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; }
  .bar{
    display:grid; gap:10px;
    grid-template-columns: repeat(4, minmax(0,1fr));
  }
  .card{
    background: var(--glass);
    border: 1px solid var(--ring);
    border-radius: 18px; padding: 12px 12px;
    box-shadow: var(--shadow);
  }
  .chips{ display:flex; gap:8px; flex-wrap:wrap }
  .chip{
    padding:8px 12px; border-radius: 999px; cursor:pointer; user-select:none;
    border:1px solid var(--ring); background:var(--card);
    transition: transform .08s ease, background 200ms ease, border 200ms ease;
  }
  .chip:hover{ transform: translateY(-1px) }
  .chip.active{ outline: 2px solid var(--accent); background: linear-gradient(180deg, rgba(98,208,255,0.15), transparent) }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  select,input[type="date"],input[type="text"]{
    width:100%; padding:10px 12px; background:var(--card); color:var(--text);
    border:1px solid var(--ring); border-radius:12px; outline:none;
  }
  .grid{ display:grid; gap:10px; grid-template-columns: repeat(6, minmax(0,1fr)) }
  .grid > .span-2{ grid-column: span 2 }
  .grid > .span-3{ grid-column: span 3 }
  .grid > .span-6{ grid-column: span 6 }
  .right{ margin-left:auto }
  .toggle{
    padding:8px 12px; border-radius:12px; border:1px solid var(--ring); background:var(--card); cursor:pointer;
  }
  table{ width:100%; border-collapse: collapse; margin-top:10px }
  thead th{
    font-weight:600; text-align:left; padding:12px; border-bottom:1px solid var(--ring); position:sticky; top:84px; background:var(--bg);
  }
  tbody td{ padding:10px 12px; border-bottom:1px dashed var(--ring) }
  .qty{ font-variant-numeric: tabular-nums; text-align:right }
  .muted{ color: var(--muted) }
  .sumcard{ display:flex; gap:16px; align-items:center; }
  .sumcard .big{ font-weight:800; font-size: 28px }
  .fade-in{ animation: fadein .35s ease }
  @keyframes fadein{ from{opacity:0; transform: translateY(6px)} to{opacity:1; transform:none}}
  .footer{ color:var(--muted); font-size:12px; margin:20px 0 60px }
</style>
</head>
<body>
<header class="wrap">
  <div class="title">
    <div class="badge">Outgoing</div>
    <h1 style="margin:0; font-size:24px; font-weight:800;">RK KNIT FAB ‚Äì Outgoing View</h1>
    <div class="right">
      <button id="themeToggle" class="toggle" title="Toggle theme">üåô / ‚òÄÔ∏è</button>
    </div>
  </div>

  <div class="card">
    <div class="chips" id="quick">
      <div class="chip" data-range="today">Today</div>
      <div class="chip active" data-range="last3">Last 3 days</div>
      <div class="chip" data-range="week">This Week</div>
      <div class="chip" data-range="month">This Month</div>
      <div class="chip" data-range="all">All</div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div class="span-2">
        <label class="muted">Party</label>
        <select id="party"><option value="">All</option></select>
      </div>
      <div class="span-2">
        <label class="muted">Yarn</label>
        <select id="yarn"><option value="">All</option></select>
      </div>
      <div class="span-2">
        <label class="muted">Mill</label>
        <select id="mill"><option value="">All</option></select>
      </div>

      <div>
        <label class="muted">Challan No.</label>
        <input id="challan" type="text" placeholder="Search challan..." />
      </div>
      <div>
        <label class="muted">From</label>
        <input id="from" type="date" />
      </div>
      <div>
        <label class="muted">To</label>
        <input id="to" type="date" />
      </div>

      <div class="span-2">
        <label class="muted">Group by</label>
        <select id="groupBy">
          <option value="none">None</option>
          <option value="date">Date (daily)</option>
          <option value="week">Week</option>
          <option value="month">Month</option>
        </select>
      </div>

      <div class="span-3 row" style="align-items:flex-end; justify-content:flex-end">
        <button id="reset" class="toggle">Reset</button>
        <button id="apply" class="toggle" style="border-color: var(--accent)">Apply Filters</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="card sumcard fade-in" id="summary">
    <div>
      <div class="muted">Total Quantity (kgs)</div>
      <div class="big" id="total">0</div>
    </div>
    <div style="margin-left:16px">
      <div class="muted">Rows</div>
      <div class="big" id="rows">0</div>
    </div>
    <div class="muted" id="rangeTxt" style="margin-left:auto"></div>
  </div>

  <div class="card fade-in" id="tableWrap">
    <table id="tbl">
      <thead>
        <tr>
          <th>DATE</th>
          <th>CHALLAN NO.</th>
          <th>PARTIES</th>
          <th>YARNS</th>
          <th class="qty">QUANTITY (KGS)</th>
          <th>MILLS</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td class="muted" colspan="6">Loading‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>

  <div class="footer">Tip: Filters combine (e.g., Party + Yarn + Date). ‚ÄúGroup by‚Äù will summarize quantity per group.</div>
</main>

<script>
  // ------- CONFIG -------
  const API_BASE = 'https://script.google.com/macros/s/AKfycby30Tw10MQlbxrDhguutgGTJPtHzq_-_eveQD0rKwc-Dr2jEktG039_UsQBh1yGy-Co1Q/exec';

  // ------- THEME -------
  const themeToggle = document.getElementById('themeToggle');
  function setTheme(mode){
    if(mode === 'light'){ document.body.classList.add('light'); }
    else { document.body.classList.remove('light'); }
    localStorage.setItem('rk_theme', mode);
  }
  setTheme(localStorage.getItem('rk_theme') || 'dark');
  themeToggle.addEventListener('click', () => {
    setTheme(document.body.classList.contains('light') ? 'dark' : 'light');
  });

  // ------- UTIL -------
  const $ = sel => document.querySelector(sel);
  const fmt = n => Intl.NumberFormat().format(n);
  const todayISO = () => new Date().toISOString().slice(0,10);
  function startOfWeek(d){ const x = new Date(d); const day = x.getDay(); const diff = (day===0?6:day-1); x.setDate(x.getDate()-diff); x.setHours(0,0,0,0); return x; } // Mon
  function endOfWeek(d){ const x = startOfWeek(d); x.setDate(x.getDate()+6); x.setHours(23,59,59,999); return x; }
  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }

  // ------- STATE -------
  let RAW = [];
  let META = {};
  const els = {
    party: $('#party'), yarn: $('#yarn'), mill: $('#mill'),
    challan: $('#challan'), from: $('#from'), to: $('#to'),
    tbody: $('#tbody'),
    total: $('#total'), rows: $('#rows'), rangeTxt: $('#rangeTxt'),
    groupBy: $('#groupBy')
  };

  // ------- FETCH -------
  async function fetchData(params={}){
    const url = new URL(API_BASE);
    url.searchParams.set('route','getData');
    if(params.lastDays) url.searchParams.set('lastDays', params.lastDays);
    if(params.party) url.searchParams.set('party', params.party);
    if(params.yarn) url.searchParams.set('yarn', params.yarn);
    if(params.mill) url.searchParams.set('mill', params.mill);
    if(params.challan) url.searchParams.set('challan', params.challan);
    if(params.dateFrom) url.searchParams.set('dateFrom', params.dateFrom);
    if(params.dateTo) url.searchParams.set('dateTo', params.dateTo);

    els.tbody.innerHTML = `<tr><td class="muted" colspan="6">Loading‚Ä¶</td></tr>`;
    const res = await fetch(url.toString(), { method:'GET' });
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || 'API error');
    RAW = j.data || [];
    META = j.meta || {};
    populateFilters(META);
    render(RAW);
    showSummary(RAW, META);
  }

  function populateFilters(meta){
    const fill = (sel, list) => {
      const el = sel; 
      const val = el.value;
      el.innerHTML = `<option value="">All</option>` + (list||[]).map(x => `<option>${x}</option>`).join('');
      if(val) el.value = val; // try preserve
    };
    fill(els.party, meta.parties);
    fill(els.yarn, meta.yarns);
    fill(els.mill, meta.mills);
    // Date range defaults
    if(meta.range){
      if(!els.from.value && meta.range.from) els.from.value = meta.range.from;
      if(!els.to.value && meta.range.to) els.to.value = meta.range.to;
    }
  }

  // ------- RENDER -------
  function render(rows){
    const gb = els.groupBy.value;
    if(gb === 'none'){
      els.tbody.innerHTML = rows.length ? rows.map(r => rowHTML(r)).join('') : `<tr><td class="muted" colspan="6">No data</td></tr>`;
    } else {
      // summarize
      const keyFn = (r)=>{
        if(gb==='date') return r.date;
        if(gb==='week'){
          const d = new Date(r.date);
          const s = startOfWeek(d);
          const e = endOfWeek(d);
          return `Week ${s.toISOString().slice(0,10)} ‚Üí ${e.toISOString().slice(0,10)}`;
        }
        if(gb==='month'){
          const d = new Date(r.date);
          return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        }
      };
      const map = new Map();
      for(const r of rows){
        const k = keyFn(r);
        map.set(k, (map.get(k)||0) + Number(r.qty||0));
      }
      const arr = Array.from(map.entries()).map(([k,v]) => ({ k, qty:v }));
      arr.sort((a,b)=> a.k.localeCompare(b.k));
      els.tbody.innerHTML = arr.length ? arr.map(g => groupRowHTML(g)).join('') : `<tr><td class="muted" colspan="6">No data</td></tr>`;
    }
  }

  function rowHTML(r){
    return `<tr>
      <td>${r.date}</td>
      <td>${escapeHtml(r.challan)}</td>
      <td>${escapeHtml(r.party)}</td>
      <td>${escapeHtml(r.yarn)}</td>
      <td class="qty">${fmt(Number(r.qty||0))}</td>
      <td>${escapeHtml(r.mill)}</td>
    </tr>`;
  }
  function groupRowHTML(g){
    return `<tr>
      <td colspan="4"><strong>${g.k}</strong></td>
      <td class="qty"><strong>${fmt(g.qty)}</strong></td>
      <td></td>
    </tr>`;
  }
  function showSummary(rows, meta){
    const total = rows.reduce((a,b)=> a + Number(b.qty||0), 0);
    els.total.textContent = fmt(total);
    els.rows.textContent = fmt(rows.length);
    els.rangeTxt.textContent = meta?.range ? `Range: ${meta.range.from || '‚Äî'} ‚Üí ${meta.range.to || '‚Äî'}` : '';
  }

  // ------- FILTER APPLY -------
  function applyFilters(){
    const params = {};
    const chip = document.querySelector('.chip.active')?.dataset.range;

    // Quick ranges
    const now = new Date();
    if(chip === 'today'){
      params.dateFrom = todayISO();
      params.dateTo = todayISO();
    } else if(chip === 'last3'){
      params.lastDays = 3;
    } else if(chip === 'week'){
      params.dateFrom = startOfWeek(now).toISOString().slice(0,10);
      params.dateTo = endOfWeek(now).toISOString().slice(0,10);
    } else if(chip === 'month'){
      params.dateFrom = startOfMonth(now).toISOString().slice(0,10);
      params.dateTo = endOfMonth(now).toISOString().slice(0,10);
    } else if(chip === 'all'){
      // no dates set
    }

    // Custom date override if user filled
    if(els.from.value) { params.dateFrom = els.from.value; }
    if(els.to.value)   { params.dateTo   = els.to.value; }

    // Other filters
    if(els.party.value)  params.party = els.party.value;
    if(els.yarn.value)   params.yarn = els.yarn.value;
    if(els.mill.value)   params.mill = els.mill.value;
    if(els.challan.value) params.challan = els.challan.value;

    // Persist last selection
    localStorage.setItem('rk_filters', JSON.stringify({
      chip, params, groupBy: els.groupBy.value
    }));

    fetchData(params).catch(err=>{
      els.tbody.innerHTML = `<tr><td class="muted" colspan="6">Error: ${escapeHtml(err.message)}</td></tr>`;
    });
  }

  // ------- EVENTS -------
  document.getElementById('quick').addEventListener('click', (e)=>{
    const t = e.target.closest('.chip'); if(!t) return;
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    t.classList.add('active');
    // Clear specific dates when quick chip changes
    if(['today','last3','week','month','all'].includes(t.dataset.range)){
      els.from.value = ''; els.to.value = '';
    }
    applyFilters();
  });

  document.getElementById('apply').addEventListener('click', applyFilters);
  document.getElementById('reset').addEventListener('click', ()=>{
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    document.querySelector('.chip[data-range="last3"]').classList.add('active');
    els.party.value = ''; els.yarn.value=''; els.mill.value=''; els.challan.value='';
    els.from.value=''; els.to.value=''; els.groupBy.value='none';
    localStorage.removeItem('rk_filters');
    applyFilters();
  });

  els.groupBy.addEventListener('change', ()=> render(RAW));
  [els.party, els.yarn, els.mill].forEach(el => el.addEventListener('change', ()=> applyFilters()));
  els.challan.addEventListener('keydown', (e)=>{ if(e.key==='Enter') applyFilters(); });

  // ------- SECURITY: escape -------
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

  // ------- INIT -------
  (function init(){
    // restore
    try{
      const saved = JSON.parse(localStorage.getItem('rk_filters')||'null');
      if(saved){
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        if(saved.chip) document.querySelector(`.chip[data-range="${saved.chip}"]`)?.classList.add('active');
        els.groupBy.value = saved.groupBy || 'none';
      }
    }catch{}
    // default: last 3 days
    applyFilters();
  })();
</script>
</body>
</html>
